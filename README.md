# Сервис Биллинга  

Сервис биллинга позволяет делать покупки фильмов и подписок кинотеатра, предоставляя единое API для веб и мобильных клиентов для осуществления платежей, просмотра и отслеживания купленных товаров для каждого пользователя, заведения новых и редактирование имеющихся товаров - подписок и фильмов с установкой их цен и срока действия, с поддержкой рекурентных платежей и отписок. Для удобства контроля оплаты и решения денежных вопросов с пользователями так же предоставляем удобную админку. В качестве платежного шлюза используется внешняя, зарекомендовавшая себя безопасная платежная система - в настоящий момент это Stripe, но мы строили сервис таким образом, чтобы при случае переход на другую платежную систему был как можно более легким и безболезненным. В комплекте имеется небольшой mvp. 


## Используемые технологии

- Асинхронное API создано на **FastAPI**
- В качестве базы данных для хранения купленных пользователями и продающихся фильмов и подписок используется **PostgreSQL**
- Очереди задач реализованы на основе брокера **RabbitMQ**
- Сервис также взаимодействует с **Kafka**, через которую стримятся отчетные события.
- Виртуализация (пока частичная) осуществляется в **Docker**, взаимодействие между контейнерами через **Docker Compose.**
- MVP выполнен на html/css/javascript
- Админка также частично кастомизирована с использованием html/css/js

## Основные компоненты системы

1. **Billing API** — асинхронное API для очуществления/возвращения покупок и отслеживания купленных фильмов/подписок, а также заведения новых товаров и редактирования цен и срока действия.
2. **PostgreSQL** — реляционное хранилище данных для покупок и продающихся товаров - фильмов и подписок
3. **Subscription Renewal Worker** - воркер продления подписок - для реализации рекурретнтых платежей без участия пользователей
4. **Админка** - для удобного контроля платежей, установки цен и тп и решения денежных вопросов с пользователями
5. **Брокер сообщений** - для реализации очередей на продление подписок в фоне и снятия нагрузки с API
6. Также используем уже имеющуюся **Кафку** для трансляции отчетных событий о попупках и продлениях/завершениях подписок на сервисы авторизации и нотификации
7. *MVP* - Пример использования сервиса биллинга в небольшом приложении.

## Схема сервиса

![notifications](/architecture/c4_billing.png)

## Запуск приложения

Запуск компонентов приложения (за исключением воркера, который еще не успели упаковать) осуществляется через **Docker Compose.** 
Перед запуском необходимо определить нужные переменные среды в файле `.env`. В качестве примера в репозитории лежит файл `.env.example`.  
Cам запуск компонентов выглядит так: 
  1. Create docker external network
```bash
docker network create movies
```

  2. Build and running
```bash
docker-compose up --build
```